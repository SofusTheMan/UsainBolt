{% extends "base.html" %}

{% block content %}
<h2>Upload a Meter</h2>
<form id="uploadForm" method="POST" enctype="multipart/form-data">
    <label for="username">Username:</label>
    <input type="text" id="username" name="username" list="usernames" autocomplete="off" required>
    <datalist id="usernames">
        {% for user in users %}
        <option value="{{ user.username }}">
        {% endfor %}
    </datalist>

    <label for="description">Description (optional):</label>
    <input type="text" name="description">

    <label for="time_seconds">Time (seconds):</label>
    <input type="number" step="0.01" name="time_seconds" required>

    <label for="video">Video File:</label>
    <input type="file" name="video" accept="video/*" required>

    <!-- Profile picture field - only shows for new users -->
    <div id="profilePictureSection" style="display: none;">
        <hr>
        <p><strong>New User Detected!</strong></p>
        <label for="profile_picture">Profile Picture (optional):</label>
        <input type="file" name="profile_picture" accept="image/*">
        <p style="font-size: 0.9em; color: #666;">You can add or change this later from your profile page.</p>
    </div>

    <button type="submit">Upload</button>
</form>

<script>
    const usernameInput = document.getElementById("username");
    const profilePictureSection = document.getElementById("profilePictureSection");
    
    // Collect existing usernames (from datalist)
    const existingNames = Array.from(document.querySelectorAll("#usernames option"))
        .map(opt => opt.value.toLowerCase());

    // Check username as user types
    usernameInput.addEventListener("input", function() {
        const typedName = usernameInput.value.trim().toLowerCase();
        
        if (typedName && !existingNames.includes(typedName)) {
            // Show profile picture field for new users
            profilePictureSection.style.display = "block";
        } else {
            // Hide it for existing users
            profilePictureSection.style.display = "none";
        }
    });

    document.getElementById("uploadForm").addEventListener("submit", function(event) {
        const typedName = usernameInput.value.trim().toLowerCase();

        if (!existingNames.includes(typedName)) {
            const confirmNew = confirm(
                `"${usernameInput.value}" is a new user. Did you mean to create a new user?`
            );
            if (!confirmNew) {
                // stop form submission so the user can change it
                event.preventDefault();
                usernameInput.focus();
            }
        }
    });
</script>
{% endblock %}